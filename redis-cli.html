<!DOCTYPE html>
<html>
<head>
    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Page Meta -->
    <title>Redis 是如何处理命令的（客户端）</title>
    <meta name="description" content="A beautiful narrative written with the world's most elegant publishing platform. The story begins here." />

    <!-- Mobile Meta -->
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Brand icon -->
    <link rel="shortcut icon" href="/blogs/assets/images/favicon.ico" >

    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/blogs/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <link rel="stylesheet" type="text/css" href="/blogs/assets/css/syntax.css" />

    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!-- Ghost outputs important style and meta data with this tag -->
        <link rel="canonical" href="/blogs//redis-cli" />
    <meta name="referrer" content="origin" />
    <link rel="next" href="/blogs/page2/" />

    <meta property="og:site_name" content="Brightness" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Redis 是如何处理命令的（客户端）" />
    <meta property="og:description" content="A beautiful narrative written with the world's most elegant publishing platform. The story begins here." />
    <meta property="og:url" content="/blogs//redis-cli" />
    <meta property="og:image" content="/blogs/assets/images/cover1.jpg" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Redis 是如何处理命令的（客户端）" />
    <meta name="twitter:description" content="A beautiful narrative written with the world's most elegant publishing platform. The story begins here." />
    <meta name="twitter:url" content="/blogs//redis-cli" />
    <meta name="twitter:image:src" content="/blogs/assets/images/cover1.jpg" />

    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Website",
    "publisher": "Brightness",
    "name": "Redis 是如何处理命令的（客户端）",
    "url": "/blogs//redis-cli",
    "image": "/blogs/assets/images/cover1.jpg",
    "description": "A beautiful narrative written with the world's most elegant publishing platform. The story begins here."
}
    </script>

    <meta name="generator" content="Jekyll 3.0.0" />
    <link rel="alternate" type="application/rss+xml" title="Brightness" href="/blogs/feed.xml" />


</head>
<body class="home-template nav-closed">

    <!-- The blog navigation links -->
    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        <li class="nav-home " role="presentation"><a href="/blogs/">Home</a></li>
        <li class="nav-about " role="presentation"><a href="/blogs/about">About</a></li>
        <li class="nav-fables " role="presentation"><a href="/blogs/tag/fables">Fables</a></li>
        <li class="nav-speeches " role="presentation"><a href="/blogs/tag/speeches">Speeches</a></li>
        <li class="nav-fiction " role="presentation"><a href="/blogs/tag/fiction">Fiction</a></li>
        <li class="nav-author " role="presentation"><a href="/blogs/author/casper">Casper</a></li>
        <li class="nav-author " role="presentation"><a href="/blogs/author/edgar">Edgar</a></li>
        <li class="nav-author " role="presentation"><a href="/blogs/author/abraham">Abraham</a></li>
        <li class="nav-author " role="presentation"><a href="/blogs/author/martin">Martin</a></li>
        <li class="nav-author " role="presentation"><a href="/blogs/author/lewis">Lewis</a></li>
    </ul>
    <a class="subscribe-button icon-feed" href="/blogs/feed.xml">Subscribe</a>
</div>
<span class="nav-cover"></span>


    <div class="site-wrapper">

        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The comment above "< default" means - insert everything in this file into -->
    <!-- the [body] of the default.hbs template, which contains our header/footer. -->

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<header class="main-header post-head no-cover">
    <nav class="main-nav  clearfix">
        
        
    </nav>
</header>

<main class="content" role="main">

    <article class="">

        <header class="post-header">
            <h1 class="post-title">Redis 是如何处理命令的（客户端）</h1>
            <section class="post-meta">
            <!-- <a href='/blogs/'></a> -->

            
                
            
                
            
                
            
                
            
                
            
            <time class="post-date" datetime="2016-12-23">23 Dec 2016</time>
                <!-- [[tags prefix=" on "]] -->
                
                on
                
                    
                       <a href='/blogs/tag/redis'>Redis</a>,
                    
                
                    
                       <a href='/blogs/tag/server'>Server</a>,
                    
                
                    
                       <a href='/blogs/tag/database'>Database</a>,
                    
                
                    
                       <a href='/blogs/tag/nosql'>Nosql</a>
                    
                
                
            </section>
        </header>

        <section class="post-content">

            <p>在使用 Redis 的过程中经常会好奇，在 Redis-Cli 中键入 <code class="highlighter-rouge">SET KEY MSG</code> 并回车之后，Redis 客户端和服务是如何对命令进行解析处理的，而在内部的实现过程是什么样的。</p>

<p>这两篇文章会分别介绍 Redis 客户端和服务端分别对命令是如何处理的，本篇文章介绍的是 Redis 客户端如何处理输入的命令、向服务发送命令以及取得服务端回复并输出到终端等过程。</p>

<p><img src="https://img.draveness.me/2016-12-23-redis-client-server.jpg-1000width" alt="redis-client-serve" /></p>

<p>文章中会将 Redis 服务看做一个输入为 Redis 命令，输出为命令执行结果的黑箱，对从命令到结果的过程不做任何解释，只会着眼于客户端的逻辑，也就是上图中的 1 和 4 两个过程。</p>

<h2 id="从-main-函数开始">从 main 函数开始</h2>

<p>与其它的 C 语言框架/服务类似，Redis 的客户端 <code class="highlighter-rouge">redis-cli</code> 也是从 <code class="highlighter-rouge">main</code> 函数开始执行的，位于 <code class="highlighter-rouge">redis-cli.c</code> 文件的最后：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">config</span><span class="p">.</span><span class="n">eval</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">repl</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>在一般情况下，Redis 客户端都会进入 <code class="highlighter-rouge">repl</code> 模式，对输入进行解析；</p>

<blockquote>
  <p>Redis 中有好多模式，包括：Latency、Slave、Pipe、Stat、Scan、LRU test 等等模式，不过这些模式都不是这篇文章关注的重点，我们只会关注最常见的 repl 模式。</p>
</blockquote>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">void</span> <span class="nf">repl</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">argc</span><span class="p">;</span>
    <span class="n">sds</span> <span class="o">*</span><span class="n">argv</span><span class="p">;</span>

    <span class="p">...</span>

    <span class="k">while</span><span class="p">((</span><span class="n">line</span> <span class="o">=</span> <span class="n">linenoise</span><span class="p">(</span><span class="n">context</span> <span class="o">?</span> <span class="n">config</span><span class="p">.</span><span class="n">prompt</span> <span class="o">:</span> <span class="s">"not connected&gt; "</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'\0'</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">argv</span> <span class="o">=</span> <span class="n">cliSplitArgs</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">argv</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"Invalid argument(s)</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">"???"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="p">...</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">issueCommandRepeat</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>在上述代码中，我们省略了大量的实现细节，只保留整个 <code class="highlighter-rouge">repl</code> 中循环的主体部分，方便进行理解和分析，在 <code class="highlighter-rouge">while</code> 循环中的条件你可以看到 <code class="highlighter-rouge">linenoise</code> 方法的调用，通过其中的 <code class="highlighter-rouge">prompt</code> 和 <code class="highlighter-rouge">not connected&gt; </code> 可以判断出，这里向终端中输出了提示符，同时会调用 <code class="highlighter-rouge">fgets</code> 从标准输入中读取字符串：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">:</span><span class="mi">6379</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>全局搜一下 <code class="highlighter-rouge">config.prompt</code> 不难发现这一行代码，也就是控制命令行提示的 <code class="highlighter-rouge">prompt</code>：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">anetFormatAddr</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">prompt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">prompt</span><span class="p">),</span><span class="n">config</span><span class="p">.</span><span class="n">hostip</span><span class="p">,</span> <span class="n">config</span><span class="p">.</span><span class="n">hostport</span><span class="p">);</span>
</code></pre></div></div>

<p>接下来执行的 <code class="highlighter-rouge">cliSplitArgs</code> 函数会将 <code class="highlighter-rouge">line</code> 中的字符串分割成几个不同的参数，然后根据字符串 <code class="highlighter-rouge">argv[0]</code> 的不同执行的命令，在这里省略了很多原有的代码：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">"quit"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
    <span class="n">strcasecmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">"exit"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">':'</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cliSetPreferences</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span><span class="n">argc</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">continue</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">"restart"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">"connect"</span><span class="p">))</span> <span class="p">{</span>
    <span class="p">...</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">"clear"</span><span class="p">))</span> <span class="p">{</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">issueCommandRepeat</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>在遇到 <code class="highlighter-rouge">quit</code>、<code class="highlighter-rouge">exit</code> 等跟<strong>客户端状态有关的命令</strong>时，就会直接执行相应的代码；否则就会将命令和参数 <code class="highlighter-rouge">issueCommandRepeat</code> 函数。</p>

<h3 id="追踪一次命令的执行">追踪一次命令的执行</h3>

<blockquote>
  <p>Redis Commit： <code class="highlighter-rouge">790310d89460655305bd615bc442eeaf7f0f1b38</code></p>

  <p>lldb： lldb-360.1.65</p>

  <p>macOS 10.11.6</p>
</blockquote>

<p>在继续分析 <code class="highlighter-rouge">issueCommandRepeat</code> 之前，我们先对 Redis 中的这部分代码进行调试追踪，在使用 <code class="highlighter-rouge">make</code> 编译了 Redis 源代码，启动 <code class="highlighter-rouge">redis-server</code> 之后；启动 lldb 对 Redis 客户端进行调试：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>lldb src/redis-cli
<span class="o">(</span>lldb<span class="o">)</span> target create <span class="s2">"src/redis-cli"</span>
Current executable <span class="nb">set </span>to <span class="s1">'src/redis-cli'</span> <span class="o">(</span>x86_64<span class="o">)</span><span class="nb">.</span>
<span class="o">(</span>lldb<span class="o">)</span> b redis-cli.c:1290
Breakpoint 1: where <span class="o">=</span> redis-cli<span class="sb">`</span>repl + 228 at redis-cli.c:1290, address <span class="o">=</span> 0x0000000100008cd4
<span class="o">(</span>lldb<span class="o">)</span> process launch
Process 8063 launched: <span class="s1">'~/redis/src/redis-cli'</span> <span class="o">(</span>x86_64<span class="o">)</span>
127.0.0.1:6379&gt;
</code></pre></div></div>

<p>在 <code class="highlighter-rouge">redis-cli.c:1290</code> 也就是下面这行代码的地方打断点之后：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">-&gt;</span> <span class="mi">1290</span>	        <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'\0'</span><span class="p">)</span> <span class="p">{</span>
</code></pre></div></div>

<p>执行 <code class="highlighter-rouge">process launch</code> 启动 <code class="highlighter-rouge">redis-cli</code>，然后输入 <code class="highlighter-rouge">SET KEY MSG</code> 回车以及 Ctrl-C：</p>

<blockquote>
  <p>在 lldb 中调试时，回车的输入经常会有问题，在这里输入 Ctrl-C 进入信号处理器，在通过 continue 命令进入断点：</p>
</blockquote>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">:</span><span class="mi">6379</span><span class="o">&gt;</span> <span class="n">SET</span> <span class="n">KEY</span> <span class="n">MSG</span>
<span class="o">^</span><span class="n">C</span>
<span class="mi">8063</span> <span class="n">stopped</span>
<span class="o">*</span> <span class="kr">thread</span> <span class="err">#</span><span class="mi">1</span><span class="o">:</span> <span class="n">tid</span> <span class="o">=</span> <span class="mh">0xa95147</span><span class="p">,</span> <span class="mh">0x00007fff90923362</span> <span class="n">libsystem_kernel</span><span class="p">.</span><span class="n">dylib</span><span class="err">`</span><span class="n">read</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="n">stop</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">signal</span> <span class="n">SIGSTOP</span>
    <span class="n">frame</span> <span class="err">#</span><span class="mi">0</span><span class="o">:</span> <span class="mh">0x00007fff90923362</span> <span class="n">libsystem_kernel</span><span class="p">.</span><span class="n">dylib</span><span class="err">`</span><span class="n">read</span> <span class="o">+</span> <span class="mi">10</span>
<span class="n">libsystem_kernel</span><span class="p">.</span><span class="n">dylib</span><span class="err">`</span><span class="n">read</span><span class="o">:</span>
<span class="o">-&gt;</span>  <span class="mh">0x7fff90923362</span> <span class="o">&lt;+</span><span class="mi">10</span><span class="o">&gt;:</span> <span class="n">jae</span>    <span class="mh">0x7fff9092336c</span>            <span class="p">;</span> <span class="o">&lt;+</span><span class="mi">20</span><span class="o">&gt;</span>
    <span class="mh">0x7fff90923364</span> <span class="o">&lt;+</span><span class="mi">12</span><span class="o">&gt;:</span> <span class="n">movq</span>   <span class="o">%</span><span class="n">rax</span><span class="p">,</span> <span class="o">%</span><span class="n">rdi</span>
    <span class="mh">0x7fff90923367</span> <span class="o">&lt;+</span><span class="mi">15</span><span class="o">&gt;:</span> <span class="n">jmp</span>    <span class="mh">0x7fff9091c7f2</span>            <span class="p">;</span> <span class="n">cerror</span>
    <span class="mh">0x7fff9092336c</span> <span class="o">&lt;+</span><span class="mi">20</span><span class="o">&gt;:</span> <span class="n">retq</span>
<span class="p">(</span><span class="n">lldb</span><span class="p">)</span> <span class="n">c</span>
<span class="n">Process</span> <span class="mi">8063</span> <span class="n">resuming</span>

<span class="n">Process</span> <span class="mi">8063</span> <span class="n">stopped</span>
<span class="o">*</span> <span class="kr">thread</span> <span class="err">#</span><span class="mi">1</span><span class="o">:</span> <span class="n">tid</span> <span class="o">=</span> <span class="mh">0xa95147</span><span class="p">,</span> <span class="mh">0x0000000100008cd4</span> <span class="n">redis</span><span class="o">-</span><span class="n">cli</span><span class="err">`</span><span class="n">repl</span> <span class="o">+</span> <span class="mi">228</span> <span class="n">at</span> <span class="n">redis</span><span class="o">-</span><span class="n">cli</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="mi">1290</span><span class="p">,</span> <span class="n">queue</span> <span class="o">=</span> <span class="err">'</span><span class="n">com</span><span class="p">.</span><span class="n">apple</span><span class="p">.</span><span class="n">main</span><span class="o">-</span><span class="kr">thread</span><span class="err">'</span><span class="p">,</span> <span class="n">stop</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">breakpoint</span> <span class="mi">1</span><span class="p">.</span><span class="mi">1</span>
    <span class="n">frame</span> <span class="err">#</span><span class="mi">0</span><span class="o">:</span> <span class="mh">0x0000000100008cd4</span> <span class="n">redis</span><span class="o">-</span><span class="n">cli</span><span class="err">`</span><span class="n">repl</span> <span class="o">+</span> <span class="mi">228</span> <span class="n">at</span> <span class="n">redis</span><span class="o">-</span><span class="n">cli</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="mi">1290</span>
   <span class="mi">1287</span>
   <span class="mi">1288</span>	    <span class="n">cliRefreshPrompt</span><span class="p">();</span>
   <span class="mi">1289</span>	    <span class="nf">while</span><span class="p">((</span><span class="n">line</span> <span class="o">=</span> <span class="n">linenoise</span><span class="p">(</span><span class="n">context</span> <span class="o">?</span> <span class="n">config</span><span class="p">.</span><span class="n">prompt</span> <span class="o">:</span> <span class="s">"not connected&gt; "</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
<span class="o">-&gt;</span> <span class="mi">1290</span>	        <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'\0'</span><span class="p">)</span> <span class="p">{</span>
   <span class="mi">1291</span>	            <span class="n">argv</span> <span class="o">=</span> <span class="n">cliSplitArgs</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">);</span>
   <span class="mi">1292</span>	            <span class="k">if</span> <span class="p">(</span><span class="n">history</span><span class="p">)</span> <span class="n">linenoiseHistoryAdd</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
   <span class="mi">1293</span>	            <span class="k">if</span> <span class="p">(</span><span class="n">historyfile</span><span class="p">)</span> <span class="n">linenoiseHistorySave</span><span class="p">(</span><span class="n">historyfile</span><span class="p">);</span>
<span class="p">(</span><span class="n">lldb</span><span class="p">)</span>
</code></pre></div></div>

<p>输入两次 <code class="highlighter-rouge">n</code> 之后，打印 <code class="highlighter-rouge">argv</code> 和 <code class="highlighter-rouge">argc</code> 的值：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="n">lldb</span><span class="p">)</span> <span class="n">p</span> <span class="n">argc</span>
<span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="err">$</span><span class="mi">1</span> <span class="o">=</span> <span class="mi">3</span>
<span class="p">(</span><span class="n">lldb</span><span class="p">)</span> <span class="n">p</span> <span class="o">*</span><span class="n">argv</span>
<span class="p">(</span><span class="n">sds</span><span class="p">)</span> <span class="err">$</span><span class="mi">2</span> <span class="o">=</span> <span class="mh">0x0000000100106cc3</span> <span class="s">"SET"</span>
<span class="p">(</span><span class="n">lldb</span><span class="p">)</span> <span class="n">p</span> <span class="o">*</span><span class="p">(</span><span class="n">argv</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="p">(</span><span class="n">sds</span><span class="p">)</span> <span class="err">$</span><span class="mi">3</span> <span class="o">=</span> <span class="mh">0x0000000100106ce3</span> <span class="s">"KEY"</span>
<span class="p">(</span><span class="n">lldb</span><span class="p">)</span> <span class="n">p</span> <span class="o">*</span><span class="p">(</span><span class="n">argv</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
<span class="p">(</span><span class="n">sds</span><span class="p">)</span> <span class="err">$</span><span class="mi">4</span> <span class="o">=</span> <span class="mh">0x0000000100106cf3</span> <span class="s">"MSG"</span>
<span class="p">(</span><span class="n">lldb</span><span class="p">)</span> <span class="n">p</span> <span class="n">line</span>
<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="err">$</span><span class="mi">5</span> <span class="o">=</span> <span class="mh">0x0000000100303430</span> <span class="s">"SET KEY MSG</span><span class="se">\n</span><span class="s">"</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">cliSplitArgs</code> 方法成功将 <code class="highlighter-rouge">line</code> 中的字符串分隔成字符串参数，在多次执行 <code class="highlighter-rouge">n</code> 之后，进入 <code class="highlighter-rouge">issueCommandRepeat</code> 方法：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">-&gt;</span> <span class="mi">1334</span>	                    <span class="n">issueCommandRepeat</span><span class="p">(</span><span class="n">argc</span><span class="o">-</span><span class="n">skipargs</span><span class="p">,</span> <span class="n">argv</span><span class="o">+</span><span class="n">skipargs</span><span class="p">,</span> <span class="n">repeat</span><span class="p">);</span>
</code></pre></div></div>

<h2 id="对输入命令的处理">对输入命令的处理</h2>

<p>上一阶段执行 <code class="highlighter-rouge">issueCommandRepeat</code> 的函数调用栈中，会发现 Redis 并不会直接把所有的命令发送到服务端：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">issueCommandRepeat</span>
    <span class="n">cliSendCommand</span>
        <span class="n">redisAppendCommandArgv</span>
            <span class="n">redisFormatCommandArgv</span>
            <span class="n">__redisAppendCommand</span>
</code></pre></div></div>

<p>而是会在 <code class="highlighter-rouge">redisFormatCommandArgv</code> 中对所有的命令进行格式化处理，将字符串转换为符合 RESP 协议的数据。</p>

<h3 id="resp-协议">RESP 协议</h3>

<p>Redis 客户端与 Redis 服务进行通讯时，会使用名为 <strong>RESP</strong>（REdis Serialization Protocol） 的协议，它的使用非常简单，并且可以序列化多种数据类型包括整数、字符串以及数组等。</p>

<p>对于 RESP 协议的详细介绍可以看官方文档中的 <a href="https://redis.io/topics/protocol">Redis Protocol specification</a>，在这里对这个协议进行简单的介绍。</p>

<p>在将不同的数据类型序列化时，会使用第一个 byte 来表示当前数据的数据类型，以便在客户端或服务器在处理时能恢复原来的数据格式。</p>

<p><img src="https://img.draveness.me/2016-12-23-redis-resp-data-byte.jpg-1000width" alt="redis-resp-data-byte" /></p>

<p>举一个简单的例子，字符串 <code class="highlighter-rouge">OK</code> 以及错误<code class="highlighter-rouge">Error Message</code> 等不同种类的信息的 RESP 表示如下：</p>

<p><img src="https://img.draveness.me/2016-12-23-redis-resp-type-and-examples.jpg-1000width" alt="redis-resp-type-and-examples" /></p>

<p>在这篇文章中我们需要简单了解的就是 RESP “数据格式”的<strong>第一个字节用来表示数据类型</strong>，然后<strong>逻辑上属于不同部分的内容通过 CRLF（\r\n）分隔</strong>。</p>

<h3 id="数据格式的转换">数据格式的转换</h3>

<p>在 <code class="highlighter-rouge">redisFormatCommandArgv</code> 方法中几乎没有需要删减的代码，所有的命令都会以字符串数组的形式发送到客户端：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">redisFormatCommandArgv</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">target</span><span class="p">,</span> <span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">argvlen</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">totlen</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

    <span class="n">totlen</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="n">intlen</span><span class="p">(</span><span class="n">argc</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">len</span> <span class="o">=</span> <span class="n">argvlen</span> <span class="o">?</span> <span class="n">argvlen</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">:</span> <span class="n">strlen</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
        <span class="n">totlen</span> <span class="o">+=</span> <span class="n">bulklen</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">cmd</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">totlen</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

    <span class="n">pos</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span><span class="s">"*%d</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span><span class="n">argc</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">len</span> <span class="o">=</span> <span class="n">argvlen</span> <span class="o">?</span> <span class="n">argvlen</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">:</span> <span class="n">strlen</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
        <span class="n">pos</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">cmd</span><span class="o">+</span><span class="n">pos</span><span class="p">,</span><span class="s">"$%zu</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span><span class="n">len</span><span class="p">);</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">+</span><span class="n">pos</span><span class="p">,</span><span class="n">argv</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">len</span><span class="p">);</span>
        <span class="n">pos</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
        <span class="n">cmd</span><span class="p">[</span><span class="n">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\r'</span><span class="p">;</span>
        <span class="n">cmd</span><span class="p">[</span><span class="n">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\n'</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">pos</span> <span class="o">==</span> <span class="n">totlen</span><span class="p">);</span>
    <span class="n">cmd</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>

    <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">totlen</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">SET KEY MSG</code> 这一命令，经过这个方法的处理会变成：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">*</span><span class="mi">3</span><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">n</span><span class="err">$</span><span class="mi">3</span><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">nSET</span><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">n</span><span class="err">$</span><span class="mi">3</span><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">nKEY</span><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">n</span><span class="err">$</span><span class="mi">3</span><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">nMSG</span><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">n</span>
</code></pre></div></div>

<p>你可以这么理解上面的结果：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">*</span><span class="mi">3</span><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">n</span>
    <span class="err">$</span><span class="mi">3</span><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">nSET</span><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">n</span>
    <span class="err">$</span><span class="mi">3</span><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">nKEY</span><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">n</span>
    <span class="err">$</span><span class="mi">3</span><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">nMSG</span><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">n</span>
</code></pre></div></div>

<p>这是一个由三个字符串组成的数组，数组中的元素是 <code class="highlighter-rouge">SET</code>、<code class="highlighter-rouge">KEY</code> 以及 <code class="highlighter-rouge">MSG</code> 三个字符串。</p>

<p>如果在这里打一个断点并输出 <code class="highlighter-rouge">target</code> 中的内容：</p>

<p><img src="https://img.draveness.me/2016-12-23-redis-lldb-cmd.png-1000width" alt="redis-lldb-cmd" /></p>

<p>到这里就完成了对输入命令的格式化，在格式化之后还会将当前命令写入全局的 <code class="highlighter-rouge">redisContext</code> 的 <code class="highlighter-rouge">write</code> 缓冲区 <code class="highlighter-rouge">obuf</code> 中，也就是在上面的缓冲区看到的第二个方法：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">__redisAppendCommand</span><span class="p">(</span><span class="n">redisContext</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sds</span> <span class="n">newbuf</span><span class="p">;</span>

    <span class="n">newbuf</span> <span class="o">=</span> <span class="n">sdscatlen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">obuf</span><span class="p">,</span><span class="n">cmd</span><span class="p">,</span><span class="n">len</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">newbuf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">__redisSetError</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">REDIS_ERR_OOM</span><span class="p">,</span><span class="s">"Out of memory"</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">REDIS_ERR</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">c</span><span class="o">-&gt;</span><span class="n">obuf</span> <span class="o">=</span> <span class="n">newbuf</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">REDIS_OK</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="rediscontext">redisContext</h3>

<p>再继续介绍下一部分之前需要简单介绍一下 <code class="highlighter-rouge">redisContext</code> 结构体：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">struct</span> <span class="n">redisContext</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">errstr</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">obuf</span><span class="p">;</span>
    <span class="n">redisReader</span> <span class="o">*</span><span class="n">reader</span><span class="p">;</span>
<span class="p">}</span> <span class="n">redisContext</span><span class="p">;</span>
</code></pre></div></div>

<p>每一个 <code class="highlighter-rouge">redisContext</code> 的结构体都表示一个 Redis 客户端对服务的连接，而这个上下文会在每一个 redis-cli 中作为静态变量仅保存一个：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="n">redisContext</span> <span class="o">*</span><span class="n">context</span><span class="p">;</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">obuf</code> 中包含了客户端未写到服务端的数据；而 <code class="highlighter-rouge">reader</code> 是用来处理 RESP 协议的结构体；<code class="highlighter-rouge">fd</code> 就是 Redis 服务对应的文件描述符；其他的内容就不多做解释了。</p>

<p>到这里，对命令的格式化处理就结束了，接下来就到了向服务端发送命令的过程了。</p>

<h2 id="向服务器发送命令">向服务器发送命令</h2>

<p>与对输入命令的处理差不多，向服务器发送命令的方法也在 <code class="highlighter-rouge">issueCommandRepeat</code> 的调用栈中，而且藏得更深，如果不仔细阅读源代码其实很难发现：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">issueCommandRepeat</span>
    <span class="n">cliSendCommand</span>
        <span class="n">cliReadReply</span>
            <span class="n">redisGetReply</span>
               <span class="n">redisBufferWrite</span>
</code></pre></div></div>

<p>Redis 在 <code class="highlighter-rouge">redisGetReply</code> 中完成对命令的发送：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">redisGetReply</span><span class="p">(</span><span class="n">redisContext</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">reply</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">wdone</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">aux</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">aux</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">REDIS_BLOCK</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">redisBufferWrite</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="o">&amp;</span><span class="n">wdone</span><span class="p">)</span> <span class="o">==</span> <span class="n">REDIS_ERR</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">REDIS_ERR</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">wdone</span><span class="p">);</span>

        <span class="p">...</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">aux</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">reply</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">*</span><span class="n">reply</span> <span class="o">=</span> <span class="n">aux</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">REDIS_OK</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>上面的代码向 <code class="highlighter-rouge">redisBufferWrite</code> 函数中传递了全局的静态变量 <code class="highlighter-rouge">redisContext</code>，其中的 <code class="highlighter-rouge">obuf</code> 中存储了没有向 Redis 服务发送的命令：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">redisBufferWrite</span><span class="p">(</span><span class="n">redisContext</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">done</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">nwritten</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">sdslen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">obuf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">nwritten</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">obuf</span><span class="p">,</span><span class="n">sdslen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">obuf</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nwritten</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">errno</span> <span class="o">==</span> <span class="n">EAGAIN</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">REDIS_BLOCK</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">EINTR</span><span class="p">))</span> <span class="p">{</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">__redisSetError</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">REDIS_ERR_IO</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">REDIS_ERR</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nwritten</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">nwritten</span> <span class="o">==</span> <span class="p">(</span><span class="kt">signed</span><span class="p">)</span><span class="n">sdslen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">obuf</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">sdsfree</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">obuf</span><span class="p">);</span>
                <span class="n">c</span><span class="o">-&gt;</span><span class="n">obuf</span> <span class="o">=</span> <span class="n">sdsempty</span><span class="p">();</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">sdsrange</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">obuf</span><span class="p">,</span><span class="n">nwritten</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">done</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">*</span><span class="n">done</span> <span class="o">=</span> <span class="p">(</span><span class="n">sdslen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">obuf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">REDIS_OK</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>代码的逻辑其实十分清晰，调用 <code class="highlighter-rouge">write</code> 向 Redis 服务代表的文件描述符发送写缓冲区 <code class="highlighter-rouge">obuf</code> 中的数据，然后根据返回值做出相应的处理，如果命令发送成功就会清空 <code class="highlighter-rouge">obuf</code> 并将 <code class="highlighter-rouge">done</code> 指针标记为真，然后返回，这样就完成了向服务器发送命令这一过程。</p>

<p><img src="https://img.draveness.me/2016-12-23-redis-lldb-nwritten.png-1000width" alt="redis-lldb-nwritten" /></p>

<h2 id="获取服务器回复">获取服务器回复</h2>

<p>其实获取服务器回复和上文中的发送命令过程基本上差不多，调用栈也几乎完全一样：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">issueCommandRepeat</span>
    <span class="n">cliSendCommand</span>
        <span class="n">cliReadReply</span>
            <span class="n">redisGetReply</span>
                <span class="n">redisBufferRead</span>
                <span class="n">redisGetReplyFromReader</span>
            <span class="n">cliFormatReplyRaw</span>
            <span class="n">fwrite</span>
</code></pre></div></div>

<p>同样地，在 <code class="highlighter-rouge">redisGetReply</code> 中获取服务器的响应：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">redisGetReply</span><span class="p">(</span><span class="n">redisContext</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">reply</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">wdone</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">aux</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">aux</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">REDIS_BLOCK</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">redisBufferWrite</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="o">&amp;</span><span class="n">wdone</span><span class="p">)</span> <span class="o">==</span> <span class="n">REDIS_ERR</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">REDIS_ERR</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">wdone</span><span class="p">);</span>

        <span class="k">do</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">redisBufferRead</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="n">REDIS_ERR</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">REDIS_ERR</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">redisGetReplyFromReader</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="o">&amp;</span><span class="n">aux</span><span class="p">)</span> <span class="o">==</span> <span class="n">REDIS_ERR</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">REDIS_ERR</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">aux</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">reply</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">*</span><span class="n">reply</span> <span class="o">=</span> <span class="n">aux</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">REDIS_OK</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>在 <code class="highlighter-rouge">redisBufferWrite</code> 成功发送命令并返回之后，就会开始等待服务端的回复，总共分为两个部分，一是使用 <code class="highlighter-rouge">redisBufferRead</code> 从服务端读取原始格式的回复（符合 RESP 协议）：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">redisBufferRead</span><span class="p">(</span><span class="n">redisContext</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1024</span><span class="o">*</span><span class="mi">16</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">nread</span><span class="p">;</span>

    <span class="n">nread</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">nread</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">errno</span> <span class="o">==</span> <span class="n">EAGAIN</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">REDIS_BLOCK</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">EINTR</span><span class="p">))</span> <span class="p">{</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">__redisSetError</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">REDIS_ERR_IO</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">REDIS_ERR</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nread</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">__redisSetError</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">REDIS_ERR_EOF</span><span class="p">,</span><span class="s">"Server closed the connection"</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">REDIS_ERR</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">redisReaderFeed</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">reader</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">nread</span><span class="p">)</span> <span class="o">!=</span> <span class="n">REDIS_OK</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">__redisSetError</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">reader</span><span class="o">-&gt;</span><span class="n">err</span><span class="p">,</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">reader</span><span class="o">-&gt;</span><span class="n">errstr</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">REDIS_ERR</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">REDIS_OK</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>在 <code class="highlighter-rouge">read</code> 从文件描述符中成功读取数据并返回之后，我们可以打印 <code class="highlighter-rouge">buf</code> 中的内容：</p>

<p><img src="https://img.draveness.me/2016-12-23-redis-lldb-read.png-1000width" alt="redis-lldb-read" /></p>

<p>刚刚向 <code class="highlighter-rouge">buf</code> 中写入的数据还需要经过 <code class="highlighter-rouge">redisReaderFeed</code> 方法的处理，截取正确的长度；然后存入 <code class="highlighter-rouge">redisReader</code> 中：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">redisReaderFeed</span><span class="p">(</span><span class="n">redisReader</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sds</span> <span class="n">newbuf</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">maxbuf</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">sdsavail</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">maxbuf</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sdsfree</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
            <span class="n">r</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">sdsempty</span><span class="p">();</span>
            <span class="n">r</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">assert</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">newbuf</span> <span class="o">=</span> <span class="n">sdscatlen</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">len</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">newbuf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">__redisReaderSetErrorOOM</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">REDIS_ERR</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">r</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">newbuf</span><span class="p">;</span>
        <span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">sdslen</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">REDIS_OK</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>最后的 <code class="highlighter-rouge">redisGetReplyFromReader</code> 方法会从 <code class="highlighter-rouge">redisContext</code> 中取出 <code class="highlighter-rouge">reader</code>，然后反序列化 RESP 对象，最后打印出来。</p>

<p><img src="https://img.draveness.me/2016-12-23-process-end.png-1000width" alt="process-end" /></p>

<p>当我们从终端的输出中看到了 OK 以及这个命令的执行的时间时，<code class="highlighter-rouge">SET KEY MSG</code> 这一命令就已经处理完成了。</p>

<h2 id="总结">总结</h2>

<p>处理命令的过程在客户端还是比较简单的：</p>

<ol>
  <li>在一个 <code class="highlighter-rouge">while</code> 循环中，输出提示符；</li>
  <li>接收到输入命令时，对输入命令进行格式化处理；</li>
  <li>通过 <code class="highlighter-rouge">write</code> 发送到 Redis 服务，并调用 <code class="highlighter-rouge">read</code> 阻塞当前进程直到服务端返回为止；</li>
  <li>对服务端返回的数据反序列化；</li>
  <li>将结果打印到终端。</li>
</ol>

<p>用一个简单的图表示，大概是这样的：</p>

<p><img src="https://img.draveness.me/2016-12-23-redis-client-process-commands.jpg-1000width" alt="redis-client-process-commands" /></p>

<h2 id="references">References</h2>

<ul>
  <li><a href="https://redis.io/topics/protocol">Redis Protocol specification</a></li>
  <li><a href="http://draveness.me/redis-io-multiplexing/">Redis 和 I/O 多路复用</a></li>
  <li><a href="http://draveness.me/redis-eventloop">Redis 中的事件循环</a></li>
</ul>

<blockquote>

  <p>Source: http://draveness.me/redis-cli</p>
</blockquote>


        </section>

        <footer class="post-footer">

            <!-- Everything inside the #author tags pulls data from the author -->
            <!-- #author-->
            
                
            
                
            
                
            
                
            
                
            

            <!-- Add Disqus Comments -->
            

        </footer>

    </article>

</main>
<aside class="read-next">

    <!-- [[! next_post ]] -->
    
        <a class="read-next-story no-cover" href="/blogs/racsignal">
            <section class="post">
                <h2>『状态』驱动的世界：ReactiveCocoa</h2>
                <p>这篇以及之后的文章主要会对 ReactiveObjc v2.1.2 的实现进行分析，从最简单的例子中了解 ReactiveCocoa 的工作原理以及概念，也是笔者个人对于 RAC 学习的总结与理解。本文主要会围绕 RAC 中核心概念 `RACSignal` 展开，详细了解其底层实现。 ## 状态驱动 2015...</p>
            </section>
        </a>
    
    <!-- [[! /next_post ]] -->
    <!-- [[! prev_post ]] -->
    
        <a class="read-next-story prev no-cover" href="/blogs/redis-eventloop">
            <section class="post">
                <h2>Redis 中的事件循环</h2>
                <p>在目前的很多服务中，由于需要持续接受客户端或者用户的输入，所以需要一个事件循环来等待并处理外部事件，这篇文章主要会介绍 Redis 中的事件循环是如何处理事件的。 在文章中，我们会先从 Redis 的实现中分析事件是如何被处理的，然后用更具象化的方式了解服务中的不同模块是如何交流的。 aeEventLoop 在分析具体代码之前，先了解一下在事件处理中处于核心部分的 aeEventLoop 到底是什么： aeEventLoop 在 Redis 就是负责保存待处理文件事件和时间事件的结构体，其中保存大量事件执行的上下文信息，同时持有三个事件数组： aeFileEvent...</p>
            </section>
        </a>
    
    <!-- [[! /prev_post ]] -->
</aside>

<!-- /post -->


        <!-- The tiny footer at the very bottom -->
        <footer class="site-footer clearfix">
          <section class="copyright"><a href="/blogs/">Brightness</a> &copy; 2018</section>
          <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> using <a href="https://github.com/jekyller/jasper">Jasper</a></section>
        </footer>
    </div>
    <!-- highlight.js -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <!-- jQuery needs to come before `` so that jQuery can be used in code injection -->
    <script type="text/javascript" src="//code.jquery.com/jquery-1.12.0.min.js"></script>
    <!-- Ghost outputs important scripts and data with this tag -->
    <!--  -->
    <!-- Add Google Analytics  -->
        <!-- Google Analytics Tracking code -->
     <script>
	    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	    ga('create', 'UA-69281367-1', 'auto');
	    ga('send', 'pageview');

     </script>
    <!-- Fitvids makes video embeds responsive and awesome -->
    <script type="text/javascript" src="/blogs/assets/js/jquery.fitvids.js"></script>
    <!-- The main JavaScript file for Casper -->
    <script type="text/javascript" src="/blogs/assets/js/index.js"></script>

</body>
</html>
